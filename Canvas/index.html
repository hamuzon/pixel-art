<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Canvas App</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
<style>
:root{--bg:#050505;--panel:rgba(22,22,24,0.85);--text:#fff;--sub:#8e8e93;--border:rgba(255,255,255,0.12);--accent:#007aff;--input:#1c1c1e;--hover:rgba(255,255,255,0.1);}
[data-theme="light"]{--bg:#f5f5f7;--panel:rgba(255,255,255,0.8);--text:#1d1d1f;--sub:#86868b;--border:rgba(0,0,0,0.1);--accent:#007aff;--input:#fff;--hover:rgba(0,0,0,0.05);}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;font-family:'Inter',sans-serif;}
body,html{margin:0;padding:0;height:100%;width:100%;background:var(--bg);color:var(--text);overflow:hidden;transition:background 0.4s ease;}
h1{margin:0;font-size:20px;font-weight:900;letter-spacing:-0.8px;color:var(--accent);text-transform:uppercase;}
#viewport{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background-image:radial-gradient(var(--border) 1.2px,transparent 1.2px);background-size:32px 32px;touch-action:none;}
#stage-container{position:relative;background:#fff;box-shadow:0 40px 120px rgba(0,0,0,0.7);transform-origin:center;will-change:transform;}
canvas{position:absolute;inset:0;width:100%;height:100%;cursor:crosshair;}
#interaction-layer{position:absolute;inset:0;z-index:10;}
.glass{background:var(--panel);backdrop-filter:blur(25px) saturate(180%);-webkit-backdrop-filter:blur(25px) saturate(180%);border:1px solid var(--border);border-radius:24px;z-index:100;}
header{position:fixed;top:0;left:0;right:0;height:64px;display:flex;justify-content:space-between;align-items:center;padding:0 24px;background:var(--panel);border-bottom:1px solid var(--border);z-index:200;}
#toolbar{position:fixed;left:20px;top:84px;display:flex;flex-direction:column;gap:10px;padding:10px;}
#bottom-bar{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);width:90%;max-width:560px;padding:20px 30px;display:flex;flex-direction:column;gap:18px;}
.btn{width:48px;height:48px;border-radius:16px;border:none;background:transparent;color:var(--text);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:0.25s cubic-bezier(0.4,0,0.2,1);}
.btn:hover{background:var(--hover);transform:scale(1.05);}
.btn.active{background:var(--accent);color:#fff;box-shadow:0 8px 20px rgba(0,122,255,0.4);}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(20px);}
.modal-content{width:420px;padding:35px;border-radius:32px;max-height:80vh;overflow-y:auto;}
.project-card{display:flex;align-items:center;gap:16px;background:var(--input);padding:14px;border-radius:20px;margin-bottom:12px;border:1px solid var(--border);cursor:pointer;transition:0.2s;}
.project-card:hover{border-color:var(--accent);background:var(--hover);transform:translateX(5px);}
.project-thumb{width:70px;height:45px;border-radius:8px;background:#fff;object-fit:cover;border:1px solid var(--border);}
.project-info{flex:1;font-size:13px;font-weight:800;line-height:1.3;}
.delete-btn{color:#ff453a;padding:10px;border-radius:12px;transition:0.2s;}
.delete-btn:hover{background:rgba(255,69,58,0.15);}
input[type="range"]{flex:1;accent-color:var(--accent);cursor:pointer;height:6px;}
select,input[type="text"],input[type="number"]{width:100%;padding:16px;background:var(--input);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:16px;outline:none;}
.primary-btn{background:var(--accent);color:#fff;border:none;padding:18px;width:100%;border-radius:18px;font-weight:900;cursor:pointer;transition:0.2s;}
#color-circle{width:46px;height:46px;border-radius:50%;border:3px solid var(--border);position:relative;overflow:hidden;}
#pen-color{position:absolute;top:-10px;left:-10px;width:80px;height:80px;cursor:pointer;}
@media(max-width:600px){#toolbar{left:50%;top:auto;bottom:205px;transform:translateX(-50%);flex-direction:row;}#bottom-bar{bottom:20px;}header h1{font-size:16px;}}
</style>
</head>
<body data-theme="dark">

<div id="project-modal" class="modal-overlay" style="display:none;">
<div class="modal-content glass">
<h1 style="font-size:26px;margin-bottom:24px;">Project Gallery</h1>
<div id="project-list"></div>
<div style="height:20px;"></div>
<button class="primary-btn" onclick="ui.showCreateNew()">+ New Canvas</button>
<button class="primary-btn" style="background:none;color:var(--sub);font-size:14px;" onclick="ui.closeProjects()">Close</button>
</div>
</div>

<div id="create-modal" class="modal-overlay" style="display:none;">
<div class="modal-content glass">
<h1>Canvas Config</h1>
<p style="color:var(--sub);font-size:13px;margin:8px 0 30px;">Choose a workspace size</p>
<select id="size-preset" onchange="ui.onPresetChange()" style="margin-bottom:18px;">
<option value="1280x720">Landscape HD (16:9)</option>
<option value="1920x1080">Full HD (16:9)</option>
<option value="1080x1080">Square (1:1)</option>
<option value="1080x1920">Portrait (9:16)</option>
<option value="custom">Custom Dimensions...</option>
</select>
<div id="custom-res" style="display:none;gap:12px;margin-bottom:18px;">
<input type="number" id="cw" value="1280" placeholder="Width">
<input type="number" id="ch" value="720" placeholder="Height">
</div>
<button class="primary-btn" onclick="app.createNew()">Create Workspace</button>
<button class="primary-btn" style="background:none;color:var(--sub);font-size:14px;" onclick="ui.closeCreateNew()">Cancel</button>
</div>
</div>

<header>
<div style="display:flex;align-items:center;gap:16px;">
<button class="btn" onclick="ui.openProjects()"><span class="material-symbols-rounded">grid_view</span></button>
<h1>Canvas App</h1>
</div>
<div style="display:flex;gap:8px;">
<button class="btn" onclick="app.undo()"><span class="material-symbols-rounded">undo</span></button>
<button class="btn" onclick="app.redo()"><span class="material-symbols-rounded">redo</span></button>
<button class="btn" onclick="ui.toggleTheme()"><span class="material-symbols-rounded" id="theme-icon">light_mode</span></button>
<button class="btn" onclick="app.exportPng()"><span class="material-symbols-rounded">download</span></button>
</div>
</header>

<nav id="toolbar" class="glass">
<button class="btn active" data-tool="pen" onclick="app.setTool('pen')"><span class="material-symbols-rounded">brush</span></button>
<button class="btn" data-tool="airbrush" onclick="app.setTool('airbrush')"><span class="material-symbols-rounded">blur_on</span></button>
<button class="btn" data-tool="eraser" onclick="app.setTool('eraser')"><span class="material-symbols-rounded">ink_eraser</span></button>
<button class="btn" data-tool="move" onclick="app.setTool('move')"><span class="material-symbols-rounded">pan_tool</span></button>
</nav>

<main id="viewport">
<div id="stage-container">
<div id="interaction-layer"></div>
</div>
</main>

<footer id="bottom-bar" class="glass">
<div style="display:flex;align-items:center;gap:20px;">
<div id="color-circle"><input type="color" id="pen-color" value="#000000"></div>
<input type="range" id="pen-size" min="1" max="300" value="15">
<span style="width:40px;font-weight:900;font-size:15px;text-align:right;" id="size-val">15</span>
</div>
<div style="display:flex;align-items:center;gap:20px;">
<span style="font-size:10px;font-weight:900;letter-spacing:1px;color:var(--sub);">OPACITY</span>
<input type="range" id="pen-opacity" min="0.01" max="1" step="0.01" value="1.0">
</div>
</footer>

<script>
const state={currentId:null,w:1280,h:720,tool:'pen',scale:1,tx:0,ty:0,drawing:false,lx:0,ly:0,undoStack:[],redoStack:[],inkPresenter:null};
const app={
async boot(){
if(navigator.ink?.requestPresenter){try{state.inkPresenter=await navigator.ink.requestPresenter();}catch{}}
const list=this.getProjects();
const lastId=localStorage.getItem('canvas_last_id');
if(lastId&&list.find(p=>p.id===lastId)){this.loadProject(lastId);}
else if(list.length>0){this.loadProject(list[0].id);}
else{ui.showCreateNew();}
},
getProjects(){return JSON.parse(localStorage.getItem('canvas_projects')||'[]');},
saveToStorage(){
if(!state.currentId)return;
localStorage.setItem(`canvas_data_${state.currentId}`,this.canvas.toDataURL());
localStorage.setItem('canvas_last_id',state.currentId);
const list=this.getProjects();
const idx=list.findIndex(p=>p.id===state.currentId);
if(idx!==-1){list[idx].thumb=this.canvas.toDataURL();list[idx].updated=Date.now();localStorage.setItem('canvas_projects',JSON.stringify(list));}
},
exportPng(){const link=document.createElement('a');link.download=`Art_${state.currentId}.png`;link.href=this.canvas.toDataURL();link.click();},
createNew(){const preset=document.getElementById('size-preset').value;let w,h;if(preset==='custom'){w=+document.getElementById('cw').value||1280;h=+document.getElementById('ch').value||720;}else{[w,h]=preset.split('x').map(Number);}
const newId='id_'+Date.now();const list=this.getProjects();list.unshift({id:newId,w,h,thumb:'',updated:Date.now()});localStorage.setItem('canvas_projects',JSON.stringify(list));
state.currentId=newId;state.w=w;state.h=h;
this.setup();this.ctx.fillStyle="#ffffff";this.ctx.fillRect(0,0,w,h);this.saveToStorage();ui.closeCreateNew();ui.closeProjects();
},
loadProject(id){const project=this.getProjects().find(p=>p.id===id);if(!project)return;state.currentId=id;state.w=project.w;state.h=project.h;this.setup();const img=new Image();img.onload=()=>{this.ctx.clearRect(0,0,state.w,state.h);this.ctx.drawImage(img,0,0);};img.src=localStorage.getItem(`canvas_data_${id}`);ui.closeProjects();localStorage.setItem('canvas_last_id',id);},
deleteProject(id,e){e.stopPropagation();if(!confirm("Are you sure you want to delete this project?"))return;let list=this.getProjects();list=list.filter(p=>p.id!==id);localStorage.setItem('canvas_projects',JSON.stringify(list));localStorage.removeItem(`canvas_data_${id}`);if(state.currentId===id){if(list.length>0)this.loadProject(list[0].id);else ui.showCreateNew();}else{ui.openProjects();}},
setup(){const container=document.getElementById('stage-container');container.innerHTML='<div id="interaction-layer"></div>';container.style.width=state.w+'px';container.style.height=state.h+'px';
this.canvas=document.createElement('canvas');this.canvas.width=state.w;this.canvas.height=state.h;this.ctx=this.canvas.getContext('2d',{willReadFrequently:true});container.insertBefore(this.canvas,document.getElementById('interaction-layer'));
this.bind();this.fit();state.undoStack=[];state.redoStack=[];
},
getPos(e){const rect=this.canvas.getBoundingClientRect();const clientX=e.clientX??e.touches?.[0].clientX;const clientY=e.clientY??e.touches?.[0].clientY;return{x:(clientX-rect.left)*(state.w/rect.width),y:(clientY-rect.top)*(state.h/rect.height)};},
bind(){const il=document.getElementById('interaction-layer');const onStart=(e)=>{if(state.tool==='move'){state.drawing=true;state.lx=e.clientX;state.ly=e.clientY;return;}this.pushUndo();state.drawing=true;const p=this.getPos(e);state.lx=p.x;state.ly=p.y;this.draw(p.x,p.y,e.pressure||0.5);};
const onMove=(e)=>{if(!state.drawing&&state.tool!=='move')return;const cx=e.clientX??e.touches?.[0].clientX;const cy=e.clientY??e.touches?.[0].clientY;if(state.tool==='move'&&state.drawing){state.tx+=(cx-state.lx);state.ty+=(cy-state.ly);state.lx=cx;state.ly=cy;this.updateView();}else if(state.drawing){const p=this.getPos(e);this.draw(p.x,p.y,e.pressure||0.5);state.lx=p.x;state.ly=p.y;}};
const onEnd=()=>{if(state.drawing)this.saveToStorage();state.drawing=false;};
il.addEventListener('pointerdown',onStart);window.addEventListener('pointermove',onMove);window.addEventListener('pointerup',onEnd);
window.addEventListener('wheel',(e)=>{e.preventDefault();state.scale*=(e.deltaY>0?0.9:1.1);this.updateView();},{passive:false});
if(state.inkPresenter){state.inkPresenter.addEventListener('stroke',(s)=>{const p=s.points[0];this.draw(p.x*this.canvas.width,p.y*this.canvas.height,p.pressure);});}
},
draw(x,y,pressure){const ctx=this.ctx;ctx.lineCap='round';ctx.lineJoin='round';ctx.globalAlpha=document.getElementById('pen-opacity').value;const size=document.getElementById('pen-size').value*(pressure>0?pressure*1.5:1);if(state.tool==='eraser'){ctx.globalCompositeOperation='destination-out';}else{ctx.globalCompositeOperation='source-over';ctx.strokeStyle=document.getElementById('pen-color').value;ctx.shadowBlur=(state.tool==='airbrush')?size/2:0;ctx.shadowColor=(state.tool==='airbrush')?ctx.strokeStyle:'transparent';}ctx.lineWidth=size;ctx.beginPath();ctx.moveTo(state.lx,state.ly);ctx.lineTo(x,y);ctx.stroke();},
updateView(){document.getElementById('stage-container').style.transform=`translate(${state.tx}px,${state.ty}px) scale(${state.scale})`;},
fit(){const v=document.getElementById('viewport');state.scale=Math.min((v.clientWidth-80)/state.w,(v.clientHeight-220)/state.h,1);state.tx=0;state.ty=0;this.updateView();},
setTool(t){state.tool=t;document.querySelectorAll('#toolbar .btn').forEach(b=>b.classList.remove('active'));document.querySelector(`[data-tool="${t}"]`).classList.add('active');},
pushUndo(){state.undoStack.push(this.canvas.toDataURL());if(state.undoStack.length>20)state.undoStack.shift();},
undo(){if(state.undoStack.length){state.redoStack.push(this.canvas.toDataURL());this.restore(state.undoStack.pop());}},
redo(){if(state.redoStack.length){state.undoStack.push(this.canvas.toDataURL());this.restore(state.redoStack.pop());}},
restore(data){const img=new Image();img.onload=()=>{this.ctx.globalCompositeOperation='source-over';this.ctx.globalAlpha=1;this.ctx.clearRect(0,0,state.w,state.h);this.ctx.drawImage(img,0,0);this.saveToStorage();};img.src=data;}
};

const ui={openProjects(){const list=app.getProjects();const container=document.getElementById('project-list');container.innerHTML=list.map(p=>`<div class="project-card" onclick="app.loadProject('${p.id}')"><img src="${p.thumb||''}" class="project-thumb"><div class="project-info">${p.w} x ${p.h}<br><span style="color:var(--sub);font-weight:400;font-size:10px;">${new Date(p.updated).toLocaleString()}</span></div><div class="delete-btn material-symbols-rounded" onclick="app.deleteProject('${p.id}',event)">delete</div></div>`).join('');document.getElementById('project-modal').style.display='flex';},closeProjects(){document.getElementById('project-modal').style.display='none';},showCreateNew(){document.getElementById('create-modal').style.display='flex';},closeCreateNew(){document.getElementById('create-modal').style.display='none';},onPresetChange(){document.getElementById('custom-res').style.display=(document.getElementById('size-preset').value==='custom')?'flex':'none';},toggleTheme(){const next=document.body.getAttribute('data-theme')==='dark'?'light':'dark';document.body.setAttribute('data-theme',next);document.getElementById('theme-icon').innerText=next==='dark'?'light_mode':'dark_mode';},updateVal(v){document.getElementById('size-val').innerText=v;}};

document.getElementById('pen-size').oninput=e=>ui.updateVal(e.target.value);
window.onload=()=>app.boot();
window.onresize=()=>app.fit();
</script>

</body>
</html>

